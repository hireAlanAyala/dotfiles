name: Manage Linode VPS

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'provision'
        type: choice
        options:
          - provision
          - destroy

env:
  # User configuration
  USERNAME: developer
  SSH_PORT: 2222
  
  # Instance configuration (hardcoded)
  INSTANCE_LABEL: dev-server
  INSTANCE_TYPE: g6-standard-2
  INSTANCE_REGION: us-east
  
  # Timeouts
  SSH_WAIT_TIMEOUT: 600  # 10 minutes
  DELETION_WAIT_TIMEOUT: 300  # 5 minutes
  
  # Package lists
  ESSENTIAL_PACKAGES: "sudo ufw git curl xz age sops gnupg"
  SECURITY_PACKAGES: "fail2ban"

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      action: ${{ github.event.inputs.action }}
      instance_label: ${{ env.INSTANCE_LABEL }}
      instance_type: ${{ env.INSTANCE_TYPE }}
      instance_region: ${{ env.INSTANCE_REGION }}
      username: ${{ env.USERNAME }}
      ssh_port: ${{ env.SSH_PORT }}
      essential_packages: ${{ env.ESSENTIAL_PACKAGES }}
      security_packages: ${{ env.SECURITY_PACKAGES }}
      deletion_wait_timeout: ${{ env.DELETION_WAIT_TIMEOUT }}
    
    steps:
      - name: Validate environment
        run: |
          echo "âœ… Setup complete"
          echo "Action: ${{ github.event.inputs.action }}"
          echo "Instance: ${{ env.INSTANCE_LABEL }}"

  provision:
    needs: setup
    if: needs.setup.outputs.action == 'provision'
    uses: ./.github/workflows/provision-vps.yml
    with:
      instance_label: ${{ needs.setup.outputs.instance_label }}
      instance_type: ${{ needs.setup.outputs.instance_type }}
      instance_region: ${{ needs.setup.outputs.instance_region }}
      username: ${{ needs.setup.outputs.username }}
      ssh_port: ${{ needs.setup.outputs.ssh_port }}
      essential_packages: ${{ needs.setup.outputs.essential_packages }}
      security_packages: ${{ needs.setup.outputs.security_packages }}
    secrets:
      linode_api_token: ${{ secrets.LINODE_API_TOKEN }}
      root_password: ${{ secrets.ROOT_PASSWORD }}

  destroy:
    needs: setup
    if: needs.setup.outputs.action == 'destroy'
    uses: ./.github/workflows/destroy-vps.yml
    with:
      instance_label: ${{ needs.setup.outputs.instance_label }}
      deletion_wait_timeout: ${{ needs.setup.outputs.deletion_wait_timeout }}
    secrets:
      linode_api_token: ${{ secrets.LINODE_API_TOKEN }}